### Title: **7-Day Rolling Average Consumption_SQL**

---

### Example Table: `customer`

| **visited_on** | **amount** |
|----------------|------------|
| 2023-10-01     | 100        |
| 2023-10-02     | 200        |
| 2023-10-03     | 150        |
| 2023-10-04     | 300        |
| 2023-10-05     | 250        |
| 2023-10-06     | 400        |
| 2023-10-07     | 350        |
| 2023-10-08     | 500        |
| 2023-10-09     | 450        |
| 2023-10-10     | 600        |

---

### 问题

计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值。

• 输入：`customer` 表，包含 `visited_on`（日期）和 `amount`（消费金额）。
• 输出：每个日期的消费平均值，仅包含完整的 7 天窗口。

---

### 流程（Step by Step）

#### **Step 1: 每日消费汇总**
• **目的**：将原始表按天汇总，计算每一天的总消费金额。
• **SQL**：
    ```sql
    WITH daily_summary AS (
        SELECT 
            visited_on, 
            SUM(amount) AS daily_amount
        FROM customer
        GROUP BY visited_on
    )
    ```
• **中间结果**：
    | visited_on | daily_amount |
    |------------|--------------|
    | 2023-10-01 | 100          |
    | 2023-10-02 | 200          |
    | 2023-10-03 | 150          |
    | 2023-10-04 | 300          |
    | 2023-10-05 | 250          |
    | 2023-10-06 | 400          |
    | 2023-10-07 | 350          |
    | 2023-10-08 | 500          |
    | 2023-10-09 | 450          |
    | 2023-10-10 | 600          |

---

#### **Step 2: 计算滚动窗口的累计消费金额和天数**
• **目的**：使用窗口函数计算每个日期的滚动窗口（7 天）内的累计消费金额和天数。
• **SQL**：
    ```sql
    rolling_summary AS (
        SELECT 
            visited_on, 
            SUM(daily_amount) OVER (
                ORDER BY visited_on 
                ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
            ) AS rolling_sum,
            COUNT(*) OVER (
                ORDER BY visited_on 
                ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
            ) AS rolling_count
        FROM daily_summary
    )
    ```
• **中间结果**：
    | visited_on | rolling_sum | rolling_count |
    |------------|-------------|---------------|
    | 2023-10-01 | 100         | 1             |
    | 2023-10-02 | 300         | 2             |
    | 2023-10-03 | 450         | 3             |
    | 2023-10-04 | 750         | 4             |
    | 2023-10-05 | 1000        | 5             |
    | 2023-10-06 | 1400        | 6             |
    | 2023-10-07 | 1750        | 7             |
    | 2023-10-08 | 2150        | 7             |
    | 2023-10-09 | 2400        | 7             |
    | 2023-10-10 | 2850        | 7             |

---

#### **Step 3: 筛选完整的 7 天窗口并计算平均值**
• **目的**：筛选出完整的 7 天窗口，并计算每天的平均消费金额。
• **SQL**：
    ```sql
    SELECT 
        visited_on, 
        ROUND(rolling_sum / 7.0, 2) AS average_amount
    FROM rolling_summary
    WHERE rolling_count = 7
    ORDER BY visited_on;
    ```
• **最终结果**：
    | visited_on | average_amount |
    |------------|----------------|
    | 2023-10-07 | 250.00         |
    | 2023-10-08 | 300.00         |
    | 2023-10-09 | 350.00         |
    | 2023-10-10 | 400.00         |

---

### 考点回顾

1. **窗口函数的使用**：
   • `SUM() OVER` 和 `COUNT() OVER` 是窗口函数的核心，用于计算范围内的聚合值。
   • `ROWS BETWEEN ... AND ...` 定义窗口范围，灵活控制计算的上下限。

2. **分组与窗口的区别**：
   • `GROUP BY` 会将数据分组，丢失组内细节。
   • 窗口函数不会改变原始数据的行数，适合在保留细节的同时进行计算。

3. **数据完整性检查**：
   • 使用 `WHERE rolling_count = 7` 确保只计算完整的 7 天窗口。

4. **日期处理**：
   • 本例中未直接使用日期函数，但窗口函数可以灵活处理日期范围。

---

### 重点函数复习

1. **窗口函数**：
   • `SUM() OVER`：计算窗口内的累计和。
   • `COUNT() OVER`：计算窗口内的行数。
   • `ROWS BETWEEN ... AND ...`：定义窗口范围。

2. **CTE（Common Table Expression）**：
   • 使用 `WITH` 定义临时表，便于分步计算和逻辑清晰。

3. **聚合函数**：
   • `SUM()`：计算总和。
   • `COUNT()`：计算行数。

4. **日期函数**：
   • 本例中未直接使用日期函数，但窗口函数可以灵活处理日期范围。

---

### 总结

通过这个完整的示例，你可以清晰地看到从原始数据到最终结果的每一步逻辑。以下是整个流程的总结：

1. **每日消费汇总**：按天汇总消费金额。
2. **滚动窗口计算**：使用窗口函数计算每个日期的滚动窗口内的累计消费金额和天数。
3. **筛选完整窗口**：只保留完整的 7 天窗口，并计算平均值。

希望这个从零开始的示例能帮助你更好地理解和复习！如果有其他问题，欢迎随时提问 😊